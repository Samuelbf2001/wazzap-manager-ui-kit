name: ğŸ” Monitoreo AutomÃ¡tico de CÃ³digo

on:
  # Ejecutar cada 12 horas
  schedule:
    - cron: '0 */12 * * *'
  
  # Permitir ejecuciÃ³n manual
  workflow_dispatch:
  
  # Ejecutar en push a main para detectar cambios inmediatamente
  push:
    branches: [ main, master ]
    paths: 
      - 'src/**'
      - 'package.json'
      - 'tsconfig.json'

jobs:
  monitor-changes:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: ğŸ”§ Instalar dependencias
      run: npm ci
    
    - name: ğŸ” Ejecutar monitoreo de cambios
      run: |
        chmod +x scripts/monitor-changes.js
        node scripts/monitor-changes.js
    
    - name: ğŸ“Š Verificar cambios generados
      id: verify-changes
      run: |
        if [[ `git status --porcelain` ]]; then
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "âœ¨ Cambios detectados en el monitoreo"
        else
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "âœ… No hay cambios para commitear"
        fi
    
    - name: ğŸ“ Configurar Git
      if: steps.verify-changes.outputs.changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action - Code Monitor"
    
    - name: ğŸ’¾ Commit cambios automatizados
      if: steps.verify-changes.outputs.changes == 'true'
      run: |
        git add REVISION_COMPLETA_APLICACION.md
        git add ALERTAS_CODIGO.md
        git add .code-tracking.json
        
        # Crear mensaje de commit con resumen
        TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
        
        # Contar archivos modificados
        MODIFIED_FILES=$(git diff --cached --name-only | wc -l)
        
        # Crear mensaje descriptivo
        COMMIT_MSG="ğŸ¤– Monitoreo automÃ¡tico: $TIMESTAMP

ğŸ“Š Resumen de cambios:
- Archivos analizados: $MODIFIED_FILES
- RevisiÃ³n actualizada automÃ¡ticamente
- Alertas de cÃ³digo generadas

ğŸ” Este commit fue generado automÃ¡ticamente por el sistema de monitoreo.
Para mÃ¡s detalles ver REVISION_COMPLETA_APLICACION.md y ALERTAS_CODIGO.md"

        git commit -m "$COMMIT_MSG"
    
    - name: ğŸš€ Push cambios
      if: steps.verify-changes.outputs.changes == 'true'
      run: |
        git push origin ${{ github.ref_name }}
    
    - name: ğŸš¨ Crear issue para alertas crÃ­ticas
      if: steps.verify-changes.outputs.changes == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          // Leer archivo de alertas si existe
          if (fs.existsSync('ALERTAS_CODIGO.md')) {
            const alertsContent = fs.readFileSync('ALERTAS_CODIGO.md', 'utf8');
            
            // Verificar si hay alertas crÃ­ticas
            if (alertsContent.includes('ğŸ”´ ALERTAS CRÃTICAS')) {
              
              // Buscar issues existentes de monitoreo
              const issues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: ['ğŸ¤– monitoreo-automÃ¡tico', 'ğŸ”´ crÃ­tico'],
                state: 'open'
              });
              
              // Solo crear nuevo issue si no hay uno abierto
              if (issues.data.length === 0) {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: 'ğŸš¨ Alertas CrÃ­ticas Detectadas por Monitoreo AutomÃ¡tico',
                  body: `## ğŸ”´ Alertas CrÃ­ticas Detectadas

El sistema de monitoreo automÃ¡tico ha detectado problemas crÃ­ticos que requieren atenciÃ³n inmediata.

### ğŸ“„ Archivos Afectados
Ver detalles completos en: [ALERTAS_CODIGO.md](./ALERTAS_CODIGO.md)

### ğŸ“Š Informe Completo
RevisiÃ³n detallada disponible en: [REVISION_COMPLETA_APLICACION.md](./REVISION_COMPLETA_APLICACION.md)

### âš¡ AcciÃ³n Requerida
1. Revisar alertas crÃ­ticas inmediatamente
2. Corregir vulnerabilidades de seguridad
3. Resolver problemas de type safety
4. Actualizar documentaciÃ³n si es necesario

### ğŸ¤– InformaciÃ³n del Monitoreo
- **Timestamp**: ${new Date().toISOString()}
- **Trigger**: Monitoreo automÃ¡tico cada 12 horas
- **Branch**: ${context.ref}
- **Commit**: ${context.sha}

Este issue se cierra automÃ¡ticamente cuando se resuelven las alertas crÃ­ticas.`,
                  labels: ['ğŸ¤– monitoreo-automÃ¡tico', 'ğŸ”´ crÃ­tico', 'bug']
                });
                
                console.log('âœ… Issue creado para alertas crÃ­ticas');
              } else {
                console.log('â„¹ï¸ Issue de alertas crÃ­ticas ya existe');
              }
            }
          }
    
    - name: ğŸ’¬ Comentar en PR si aplica
      if: github.event_name == 'push' && steps.verify-changes.outputs.changes == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          // Buscar PR asociado al push
          const prs = await github.rest.pulls.list({
            owner: context.repo.owner,
            repo: context.repo.repo,
            head: `${context.repo.owner}:${context.ref.replace('refs/heads/', '')}`,
            state: 'open'
          });
          
          if (prs.data.length > 0) {
            const pr = prs.data[0];
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: `## ğŸ¤– Monitoreo AutomÃ¡tico Ejecutado

El sistema de monitoreo ha analizado los cambios en este PR:

### ğŸ“Š AnÃ¡lisis Completado
- âœ… CÃ³digo revisado automÃ¡ticamente
- ğŸ“„ Informe actualizado en \`REVISION_COMPLETA_APLICACION.md\`
- ğŸš¨ Alertas generadas en \`ALERTAS_CODIGO.md\`

### ğŸ” PrÃ³ximos Pasos
1. Revisar el informe de revisiÃ³n actualizado
2. Verificar alertas si las hay
3. Corregir problemas crÃ­ticos antes del merge

*Este comentario fue generado automÃ¡ticamente por el sistema de monitoreo.*`
            });
          }
    
    - name: ğŸ“ˆ Generar reporte de mÃ©tricas
      if: always()
      run: |
        echo "## ğŸ“Š MÃ©tricas del Monitoreo" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Timestamp**: $(date -u)" >> $GITHUB_STEP_SUMMARY
        echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Cambios detectados**: ${{ steps.verify-changes.outputs.changes }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "ALERTAS_CODIGO.md" ]; then
          echo "### ğŸš¨ Resumen de Alertas" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          head -20 ALERTAS_CODIGO.md >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ“„ **Archivos generados**:" >> $GITHUB_STEP_SUMMARY
        echo "- [RevisiÃ³n Completa](./REVISION_COMPLETA_APLICACION.md)" >> $GITHUB_STEP_SUMMARY
        echo "- [Alertas de CÃ³digo](./ALERTAS_CODIGO.md)" >> $GITHUB_STEP_SUMMARY

  # Job para cerrar issues resueltos
  cleanup-resolved-issues:
    runs-on: ubuntu-latest
    needs: monitor-changes
    if: always()
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸ” Verificar y cerrar issues resueltos
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          // Verificar si aÃºn hay alertas crÃ­ticas
          let hasCriticalAlerts = false;
          if (fs.existsSync('ALERTAS_CODIGO.md')) {
            const alertsContent = fs.readFileSync('ALERTAS_CODIGO.md', 'utf8');
            hasCriticalAlerts = alertsContent.includes('ğŸ”´ ALERTAS CRÃTICAS');
          }
          
          if (!hasCriticalAlerts) {
            // Buscar issues abiertos de monitoreo crÃ­tico
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['ğŸ¤– monitoreo-automÃ¡tico', 'ğŸ”´ crÃ­tico'],
              state: 'open'
            });
            
            // Cerrar issues resueltos
            for (const issue of issues.data) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `## âœ… Alertas CrÃ­ticas Resueltas

El sistema de monitoreo automÃ¡tico confirma que las alertas crÃ­ticas han sido resueltas.

### ğŸ‰ Estado Actual
- âœ… No se detectan alertas crÃ­ticas
- âœ… CÃ³digo en estado saludable
- âœ… Issue cerrado automÃ¡ticamente

**Timestamp**: ${new Date().toISOString()}

Â¡Excelente trabajo resolviendo los problemas crÃ­ticos! ğŸŠ`
              });
              
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed',
                state_reason: 'completed'
              });
              
              console.log(`âœ… Issue #${issue.number} cerrado - alertas crÃ­ticas resueltas`);
            }
          }