/**
 * üîß WHATSAPP CONNECTION MODAL - VERSI√ìN OPTIMIZADA
 * 
 * ‚úÖ CORRECCIONES IMPLEMENTADAS:
 * - Solo UNA petici√≥n al webhook personalizado (antes eran 8)
 * - Manejo correcto de respuestas JSON vac√≠as
 * - Prevenci√≥n de m√∫ltiples env√≠os simult√°neos
 * - Eliminaci√≥n de llamadas redundantes a n8n
 * - Logging mejorado para debugging
 * 
 * üéØ FLUJO SIMPLIFICADO:
 * 1. Usuario env√≠a formulario ‚Üí 1 llamada al webhook
 * 2. Webhook responde con QR ‚Üí Se muestra en pantalla
 * 3. Usuario escanea QR ‚Üí Solo logging interno (sin m√°s llamadas)
 */

import { useState } from "react";
import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Checkbox } from "@/components/ui/checkbox";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { QRCodeSVG } from "qrcode.react";
import { useToast } from "@/hooks/use-toast";
import { Loader2 } from "lucide-react";
import { loggerService } from "@/services/logger.service";
import { connectionMonitorService } from "@/services/connection-monitor.service";

interface WhatsAppConnectionModalProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  onConnectionSuccess: () => void;
}

interface FormData {
  name: string;
  phone_number: string;
  account_protection: boolean;
  log_messages: boolean;
  webhook_url: string;
  webhook_enabled: boolean;
  webhook_events: string[];
}

export function WhatsAppConnectionModal({ open, onOpenChange, onConnectionSuccess }: WhatsAppConnectionModalProps) {
  const { toast } = useToast();
  const [step, setStep] = useState<'form' | 'qr' | 'success'>('form');
  const [loading, setLoading] = useState(false);
  const [qrCode, setQrCode] = useState<string>('');
  const [formData, setFormData] = useState<FormData>({
    name: '',
    phone_number: '',
    account_protection: true,
    log_messages: true,
    webhook_url: 'https://n8n.srv823701.hstgr.cloud/webhook/cfe44692-83e5-40a8-ac76-ae24154419a1',
    webhook_enabled: true,
    webhook_events: ['message', 'status', 'qrcode']
  });

  const webhookEventOptions = [
    { value: 'message', label: 'Mensajes' },
    { value: 'status', label: 'Estados' },
    { value: 'qrcode', label: 'C√≥digo QR' }
  ];



  const sendToCustomWebhook = async (sessionName: string, phoneNumber: string) => {
    try {
      // ‚úÖ URL CORREGIDA: /webhook/ en lugar de /webhook-test/
      const webhookUrl = 'https://n8n-n8n.5raxun.easypanel.host/webhook/f2666a61-db14-45e0-ab5b-4bb895adb3c2';
      
      // üéØ PAYLOAD SIMPLIFICADO: Solo nombre y n√∫mero como solicitaste
      const simplePayload = {
        session_name: sessionName,
        phone_number: phoneNumber,
        timestamp: new Date().toISOString(),
        app_source: 'whatsfull_frontend'
      };
      
      // Log del request
      loggerService.logWebhookRequest(simplePayload, sessionName, phoneNumber);
      
      console.log('üì§ Enviando datos al webhook:', webhookUrl);
      console.log('üì¶ Payload simplificado:', simplePayload);
      
      const response = await fetch(webhookUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(simplePayload),
      });

      if (response.ok) {
        let responseData = null;
        
        try {
          const responseText = await response.text();
          console.log('üìÑ Respuesta raw del webhook:', responseText);
          
          if (responseText.trim()) {
            responseData = JSON.parse(responseText);
            console.log('‚úÖ Respuesta parseada del webhook:', responseData);
          } else {
            console.log('üì≠ Respuesta vac√≠a del webhook (200 OK sin contenido)');
            responseData = { success: true, message: 'Webhook procesado sin contenido' };
          }
        } catch (parseError) {
          console.warn('‚ö†Ô∏è Error parseando JSON del webhook, usando respuesta por defecto');
          responseData = { success: true, message: 'Webhook procesado sin JSON v√°lido' };
        }
        
        // Log de la respuesta exitosa
        loggerService.logWebhookResponse(responseData, sessionName, phoneNumber);
        
        return responseData;
      } else {
        const errorMsg = `Webhook respondi√≥ con error HTTP: ${response.status}`;
        console.warn(errorMsg);
        
        // Log del error HTTP
        loggerService.logWebhookError(errorMsg, sessionName, phoneNumber);
        
        return null;
      }
    } catch (error) {
      console.error('‚ùå Error enviando al webhook:', error);
      
      // Log del error de red
      loggerService.logWebhookError(
        `Error de red: ${error instanceof Error ? error.message : 'Error desconocido'}`, 
        sessionName, 
        phoneNumber
      );
      
      return null;
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    // üö´ PREVENIR M√öLTIPLES ENV√çOS
    if (loading) {
      console.log('‚ö†Ô∏è Ya hay una petici√≥n en curso, ignorando...');
      return;
    }
    
    setLoading(true);

    try {
      // Log del env√≠o del formulario
      loggerService.logFormSubmission({
        session_name: formData.name,
        phone_number: formData.phone_number,
        account_protection: formData.account_protection,
        log_messages: formData.log_messages
      });

      console.log('üöÄ Enviando petici√≥n al webhook con datos simplificados...');
      console.log('üìã Datos: Sesi√≥n:', formData.name, '| Tel√©fono:', formData.phone_number);
      
      // üî• UNA SOLA PETICI√ìN AL WEBHOOK CON DATOS SIMPLIFICADOS
      const webhookResponse = await sendToCustomWebhook(formData.name, formData.phone_number);
      
      if (webhookResponse) {
        console.log('=== üîç PROCESANDO RESPUESTA DEL WEBHOOK ===');
        console.log('Respuesta completa:', webhookResponse);
        
        // Verificar diferentes estructuras de respuesta
        const webhookData = Array.isArray(webhookResponse) ? webhookResponse[0] : webhookResponse;
        
        console.log('Datos procesados:', webhookData);
        
        // Buscar QR en diferentes ubicaciones posibles
        let qrBase64 = null;
        
        if (webhookData?.success && webhookData?.data?.base64) {
          qrBase64 = webhookData.data.base64;
          console.log('‚úÖ QR encontrado en: webhookData.data.base64');
        } else if (webhookData?.data?.base64) {
          qrBase64 = webhookData.data.base64;
          console.log('‚úÖ QR encontrado en: webhookData.data.base64 (sin success)');
        } else if (webhookData?.base64) {
          qrBase64 = webhookData.base64;
          console.log('‚úÖ QR encontrado en: webhookData.base64');
        } else if (Array.isArray(webhookResponse)) {
          // Buscar en todos los elementos del array
          for (const item of webhookResponse) {
            if (item?.data?.base64) {
              qrBase64 = item.data.base64;
              console.log('‚úÖ QR encontrado en array, elemento:', item);
              break;
            }
          }
        }
        
        if (qrBase64) {
          console.log('üéâ QR Code encontrado exitosamente!');
          console.log('üì± Aplicando QR al modal...');
          setQrCode(qrBase64);
          setStep('qr');
          
          // Log espec√≠fico para QR generado
          loggerService.logQRGenerated('webhook personalizado', formData.name, formData.phone_number);

          // üöÄ CREAR CONEXI√ìN INMEDIATAMENTE Y COMENZAR MONITOREO CADA 15 SEGUNDOS
          console.log('üîÑ Creando conexi√≥n en connectionMonitorService...');
          
          try {
            const newConnection = await connectionMonitorService.createConnection({
              name: formData.name,
              phone_number: formData.phone_number,
              status: 'active',
              instance_state: null,
              instance_name: null
            });
            
            console.log('‚úÖ Conexi√≥n creada exitosamente:', newConnection);
            console.log('‚è∞ Monitoreo cada 15 segundos iniciado autom√°ticamente');
            
            // üìù REGISTRAR CALLBACKS PARA ACTUALIZACI√ìN AUTOM√ÅTICA
            connectionMonitorService.registerQRUpdateCallback(newConnection.id, (newQR: string) => {
              console.log('üÜï Nuevo QR recibido del monitoreo, actualizando...');
              setQrCode(newQR);
              loggerService.logQRGenerated('monitoreo autom√°tico', formData.name, formData.phone_number);
            });
            
            connectionMonitorService.registerModalCloseCallback(newConnection.id, () => {
              console.log('üéâ Conexi√≥n establecida exitosamente - Cerrando modal autom√°ticamente');
              handleAutomaticSuccess();
            });
            
            console.log('üìû Callbacks registrados para actualizaciones autom√°ticas');
            
          } catch (connectionError) {
            console.error('‚ùå Error creando conexi√≥n en monitor:', connectionError);
            // Continuar mostrando QR aunque falle el monitoreo
          }
          
          toast({
            title: "‚úÖ C√≥digo QR generado",
            description: "Escanea el c√≥digo con tu WhatsApp para conectar. Se verificar√° autom√°ticamente cada 15 segundos.",
          });
          
          return; // ‚úÖ √âXITO - Salir aqu√≠
        } else {
          console.log('‚ùå No se encontr√≥ QR en la respuesta del webhook');
          console.log('üîç Estructura de respuesta recibida:', JSON.stringify(webhookResponse, null, 2));
        }
      } else {
        console.log('‚ùå El webhook no respondi√≥ o respondi√≥ con error');
      }
      
      // üö´ Si llegamos aqu√≠, algo sali√≥ mal
      throw new Error('No se pudo generar el c√≥digo QR. Intenta nuevamente.');

    } catch (error) {
      console.error('üí• Error en handleSubmit:', error);
      
      // Solo loggear el error, NO hacer m√°s peticiones
      loggerService.logWebhookError(
        error instanceof Error ? error.message : 'Error desconocido en conexi√≥n',
        formData.name,
        formData.phone_number
      );

      toast({
        title: "‚ùå Error de conexi√≥n",
        description: "No fue posible conectar. Revisa los datos e intenta nuevamente.",
        variant: "destructive"
      });
    } finally {
      setLoading(false);
    }
  };

  const handleSuccess = async () => {
    try {
      // Log del escaneo del QR (solo informativo)
      loggerService.addLog({
        type: 'qr_scanned',
        sessionName: formData.name,
        phoneNumber: formData.phone_number,
        message: 'Usuario confirm√≥ escaneo del c√≥digo QR manualmente',
        status: 'success'
      });

      // üéâ √âXITO: La conexi√≥n ya fue creada en handleSubmit
      // El monitoreo ya est√° funcionando cada 15 segundos
      console.log('üéâ Usuario confirm√≥ escaneo manual. Monitoreo contin√∫a autom√°ticamente cada 15 segundos');

      setStep('success');
      toast({
        title: "¬°Conexi√≥n en proceso!",
        description: "Se est√° verificando autom√°ticamente la conexi√≥n cada 15 segundos.",
      });
      
      // No cerrar el modal inmediatamente - dejar que el monitoreo lo cierre autom√°ticamente
      // cuando detecte que el estado cambi√≥ a "open"
      console.log('‚è≥ Esperando confirmaci√≥n autom√°tica del webhook...');
      
    } catch (error) {
      console.error('Error en confirmaci√≥n manual:', error);
    }
  };

  // üéâ FUNCI√ìN LLAMADA AUTOM√ÅTICAMENTE CUANDO EL MONITOREO DETECTA CONEXI√ìN EXITOSA
  const handleAutomaticSuccess = () => {
    console.log('üéâ ¬°Conexi√≥n WhatsApp establecida autom√°ticamente!');
    
    // Log del √©xito autom√°tico
    loggerService.addLog({
      type: 'connection_restored',
      sessionName: formData.name,
      phoneNumber: formData.phone_number,
      message: 'Conexi√≥n establecida autom√°ticamente por monitoreo',
      status: 'success'
    });

    toast({
      title: "üéâ ¬°Conexi√≥n exitosa!",
      description: "WhatsApp se ha conectado autom√°ticamente.",
    });
    
    // Cerrar modal y resetear despu√©s de un breve delay
    setTimeout(() => {
      onConnectionSuccess();
      onOpenChange(false);
      resetForm();
    }, 2000);
  };

  const resetForm = () => {
    setStep('form');
    setQrCode('');
    setFormData({
      name: '',
      phone_number: '',
      account_protection: true,
      log_messages: true,
      webhook_url: 'https://n8n-n8n.5raxun.easypanel.host/webhook/f2666a61-db14-45e0-ab5b-4bb895adb3c2',
      webhook_enabled: true,
      webhook_events: ['message', 'status', 'qrcode']
    });
  };

  const handleClose = () => {
    // üõë LIMPIAR CALLBACKS Y DETENER MONITOREO AL CERRAR MODAL
    console.log('‚ùå Cerrando modal - Deteniendo monitoreo y limpiando callbacks');
    
    // Buscar conexiones activas con el nombre de sesi√≥n actual y limpiar
    const connections = connectionMonitorService.getConnections();
    const activeConnection = connections.find(conn => 
      conn.name === formData.name && conn.status === 'active'
    );
    
    if (activeConnection) {
      console.log(`üõë Deteniendo monitoreo para: ${activeConnection.name}`);
      connectionMonitorService.stopMonitoring(activeConnection.id);
      connectionMonitorService.clearCallbacks(activeConnection.id);
    }
    
    onOpenChange(false);
    resetForm();
  };

  return (
    <Dialog open={open} onOpenChange={(isOpen) => {
      if (!isOpen) {
        handleClose();
      }
    }}>
      <DialogContent className="sm:max-w-md">
        <DialogHeader>
          <DialogTitle>
            Conectar WhatsApp
          </DialogTitle>
        </DialogHeader>

        {step === 'form' && (
          <form onSubmit={handleSubmit} className="space-y-4">
            <div className="space-y-2">
              <Label htmlFor="name">Nombre de la sesi√≥n *</Label>
              <Input
                id="name"
                value={formData.name}
                onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                placeholder="Ej: Soporte Principal"
                required
              />
            </div>

            <div className="space-y-2">
              <Label htmlFor="phone_number">N√∫mero de tel√©fono *</Label>
              <Input
                id="phone_number"
                value={formData.phone_number}
                onChange={(e) => setFormData({ ...formData, phone_number: e.target.value })}
                placeholder="Ej: +34123456789"
                required
              />
            </div>

            <div className="flex items-center space-x-2">
              <Checkbox
                id="account_protection"
                checked={formData.account_protection}
                onCheckedChange={(checked) => 
                  setFormData({ ...formData, account_protection: checked as boolean })
                }
              />
              <Label htmlFor="account_protection">Protecci√≥n de cuenta *</Label>
            </div>

            <div className="flex items-center space-x-2">
              <Checkbox
                id="log_messages"
                checked={formData.log_messages}
                onCheckedChange={(checked) => 
                  setFormData({ ...formData, log_messages: checked as boolean })
                }
              />
              <Label htmlFor="log_messages">Registrar mensajes *</Label>
            </div>

            <div className="flex gap-2">
              <Button 
                type="button" 
                variant="outline" 
                onClick={handleClose}
                className="flex-1"
              >
                Cancelar
              </Button>
              <Button type="submit" disabled={loading} className="flex-1 bg-green-600 hover:bg-green-700">
                {loading ? (
                  <>
                    <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                    Procesando...
                  </>
                ) : (
                  'Conectar'
                )}
              </Button>
            </div>
          </form>
        )}

        {step === 'qr' && (
          <div className="text-center space-y-4">
            <h3 className="text-lg font-medium">Escanea este c√≥digo con tu WhatsApp</h3>
            <div className="flex justify-center">
              {qrCode === 'sample-qr-code-pending' ? (
                <div className="w-48 h-48 bg-gray-100 flex items-center justify-center rounded">
                  <div className="text-center">
                    <Loader2 className="w-8 h-8 animate-spin mx-auto mb-2" />
                    <p className="text-sm text-gray-600">Generando c√≥digo QR...</p>
                  </div>
                </div>
              ) : qrCode.startsWith('data:image/') ? (
                // Mostrar imagen base64 recibida del webhook
                <img 
                  src={qrCode} 
                  alt="QR Code WhatsApp" 
                  className="w-48 h-48 border rounded"
                  style={{ maxWidth: '200px', maxHeight: '200px' }}
                />
              ) : (
                // Mostrar QR SVG generado (fallback)
                <QRCodeSVG value={qrCode} size={200} />
              )}
            </div>
            <p className="text-sm text-gray-600">
              Abre WhatsApp ‚Üí Configuraci√≥n ‚Üí Dispositivos vinculados ‚Üí Vincular un dispositivo
            </p>
            <div className="flex gap-2">
              <Button 
                type="button" 
                variant="outline" 
                onClick={handleClose}
                className="flex-1"
              >
                Cancelar
              </Button>
              <Button onClick={handleSuccess} className="flex-1 bg-green-600 hover:bg-green-700">
                He escaneado el c√≥digo
              </Button>
            </div>
          </div>
        )}

        {step === 'success' && (
          <div className="text-center space-y-4">
            <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto">
              <svg className="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
              </svg>
            </div>
            <h3 className="text-lg font-medium text-green-600">¬°Conexi√≥n exitosa!</h3>
            <p className="text-sm text-gray-600">WhatsApp se ha conectado correctamente.</p>
          </div>
        )}
      </DialogContent>
    </Dialog>
  );
}
